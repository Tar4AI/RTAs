<!DOCTYPE html>
<html lang="th" data-theme="studio-blue">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1a202c" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Mobile RTA (Pro)</title>
  <style>
    /* --- Theme: Dark Matter --- */
    :root, [data-theme="dark-matter"]{
      --bg1:#1a202c; --bg2:#1a202c; --card:#2d3748; --text:#cbd5e1; --muted:#718096;
      --gridH:rgba(255,255,255,.08); --gridV:rgba(255,255,255,.04);
      --frame:rgba(255,255,255,.1); --label:rgba(255,255,255,.85);
      --fft:#68d391; --peak:#b794f4; --hold:#f6ad55; --bar:#68d391;
      --heatmap-color-1:#1a202c; --heatmap-color-2:#4a5568; --heatmap-color-3:#68d391;
      --heatmap-color-4:#f6ad55; --heatmap-color-5:#e53e3e;
      --dba-meter-bg-green:#48bb78; --dba-meter-bg-yellow:#f6ad55;
      --dba-meter-bg-orange:#ed8936; --dba-meter-bg-red:#e53e3e;
      --accent-color:#2DD4BF;

      /* dropdown tones */
      --select-bg:rgba(0,0,0,.28);
      --select-bg-hover:rgba(255,255,255,.06);
      --select-border:rgba(255,255,255,.14);
      --select-border-focus:rgba(45,212,191,.65);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(45,212,191,.25);
    }

    /* --- Theme: Studio Blue (default) --- */
    [data-theme="studio-blue"]{
      --bg1:#0F172A; --bg2:#1E293B; --card:#1E293B; --text:#E2E8F0; --muted:#64748B;
      --gridH:rgba(255,255,255,.10); --gridV:rgba(255,255,255,.05);
      --frame:rgba(255,255,255,.12); --label:rgba(255,255,255,.90);
      --fft:#22D3EE; --peak:#A5B4FC; --hold:#F472B6; --bar:#22D3EE;
      --heatmap-color-1:#0F172A; --heatmap-color-2:#334155; --heatmap-color-3:#0EA5E9;
      --heatmap-color-4:#A78BFA; --heatmap-color-5:#F472B6;
      --dba-meter-bg-green:#22D3EE; --dba-meter-bg-yellow:#A78BFA;
      --dba-meter-bg-orange:#EC4899; --dba-meter-bg-red:#F43F5E;
      --accent-color:#60A5FA;

      /* dropdown tones */
      --select-bg:rgba(30,41,59,.55);
      --select-bg-hover:rgba(30,41,59,.75);
      --select-border:rgba(255,255,255,.16);
      --select-border-focus:rgba(96,165,250,.7);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(96,165,250,.25);
    }

    /* --- Theme: Vintage Amber --- */
    [data-theme="vintage-amber"]{
      --bg1:#292524; --bg2:#1c1917; --card:#44403C; --text:#D6D3D1; --muted:#A8A29E;
      --gridH:rgba(255,250,235,.10); --gridV:rgba(255,250,235,.05);
      --frame:rgba(255,250,235,.12); --label:rgba(255,255,255,.90);
      --fft:#F59E0B; --peak:#FDE68A; --hold:#FDBA74; --bar:#F59E0B;
      --heatmap-color-1:#292524; --heatmap-color-2:#78716C; --heatmap-color-3:#F59E0B;
      --heatmap-color-4:#FBBF24; --heatmap-color-5:#EF4444;
      --dba-meter-bg-green:#F59E0B; --dba-meter-bg-yellow:#FACC15;
      --dba-meter-bg-orange:#FB923C; --dba-meter-bg-red:#EF4444;
      --accent-color:#D97706;

      /* dropdown tones */
      --select-bg:rgba(0,0,0,.28);
      --select-bg-hover:rgba(255,255,255,.06);
      --select-border:rgba(255,250,235,.18);
      --select-border-focus:rgba(217,119,6,.7);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(217,119,6,.25);
    }
    
    /* --- Theme: Midnight Neon --- */
    [data-theme="midnight-neon"]{
      --bg1:#0B0914; --bg2:#120F22; --card:#1C1933; --text:#D8D3F5; --muted:#7A759C;
      --gridH:rgba(220, 210, 255, .08); --gridV:rgba(220, 210, 255, .04);
      --frame:rgba(220, 210, 255, .12); --label:rgba(220, 210, 255, .90);
      --fft:#F43F5E; --peak:#0CF1E5; --hold:#FBBF24; --bar:#F43F5E;
      --heatmap-color-1:#0B0914; --heatmap-color-2:#3D3A63; --heatmap-color-3:#BE3887;
      --heatmap-color-4:#F43F5E; --heatmap-color-5:#FBBF24;
      --dba-meter-bg-green:#0CF1E5; --dba-meter-bg-yellow:#FBBF24;
      --dba-meter-bg-orange:#F43F5E; --dba-meter-bg-red:#f43f82;
      --accent-color:#0CF1E5;

      /* dropdown tones */
      --select-bg:rgba(12, 10, 30, .55);
      --select-bg-hover:rgba(12, 10, 30, .75);
      --select-border:rgba(220, 210, 255, .18);
      --select-border-focus:rgba(12, 241, 229, .7);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(12, 241, 229, .25);
    }

    /* --- Theme: Emerald Gold --- */
    [data-theme="emerald-gold"]{
      --bg1:#0F1D1A; --bg2:#0A1412; --card:#1A2C28; --text:#E2E8F0; --muted:#8A9A95;
      --gridH:rgba(200, 220, 210, .08); --gridV:rgba(200, 220, 210, .04);
      --frame:rgba(200, 220, 210, .12); --label:rgba(226, 232, 240, .90);
      --fft:#10B981; --peak:#F59E0B; --hold:#FDE047; --bar:#10B981;
      --heatmap-color-1:#0F1D1A; --heatmap-color-2:#2F574D; --heatmap-color-3:#10B981;
      --heatmap-color-4:#F59E0B; --heatmap-color-5:#EF4444;
      --dba-meter-bg-green:#10B981; --dba-meter-bg-yellow:#F59E0B;
      --dba-meter-bg-orange:#FB923C; --dba-meter-bg-red:#EF4444;
      --accent-color:#F59E0B;

      /* dropdown tones */
      --select-bg:rgba(10, 20, 18, .55);
      --select-bg-hover:rgba(10, 20, 18, .75);
      --select-border:rgba(200, 220, 210, .18);
      --select-border-focus:rgba(245, 158, 11, .7);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(245, 158, 11, .25);
    }
    
    :root{ color-scheme:dark }
    html{ background:var(--bg1) }
    body{
      margin:0; height:100%;
      background:radial-gradient(1200px 600px at 70% -10%, var(--card) 10%, var(--bg1) 60%, var(--bg2) 100%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; overscroll-behavior:contain;
      transition: background .3s, color .3s;
    }

    /* Safe area */
    body::before,body::after{content:"";position:fixed;left:0;right:0;z-index:9999;background:var(--bg1);pointer-events:none}
    body::before{top:0;height:env(safe-area-inset-top)} body::after{bottom:0;height:env(safe-area-inset-bottom)}
    @supports(padding: env(safe-area-inset-left)){
      html::before,html::after{content:"";position:fixed;top:0;bottom:0;background:var(--bg1);z-index:9998;pointer-events:none}
      html::before{left:0;width:env(safe-area-inset-left)} html::after{right:0;width:env(safe-area-inset-right)}
    }

    .wrap{display:flex;flex-direction:column;gap:12px;max-width:920px;margin:0 auto;
      padding-left:calc(12px + env(safe-area-inset-left));
      padding-right:calc(12px + env(safe-area-inset-right));
      padding-top:calc(12px + env(safe-area-inset-top));
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px; transition: background-color .3s, border-color .3s;}

    /* === toolbar (มุมขวาบนของการ์ด) === */
    .toolbar{display:flex; align-items:center; gap:12px;}
    .toolbar .stack{display:flex; align-items:center; gap:8px;}
    .toolbar label{display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted)}
    .toolbar input[type="range"]{ width:140px; vertical-align:middle; }

    .icon-btn{ width:36px; height:32px; padding:0; display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px; font-size:16px; line-height:1; background:rgba(0,0,0,.2); border:1px solid rgba(255,255,255,.12); color:var(--text);}
    .icon-btn svg{ width:20px; height:20px; pointer-events:none; display:block; }
    .icon-btn[data-active="1"]{ outline:1px solid rgba(255,255,255,.18); }

    @media (max-width:480px){
      .toolbar input[type="range"]{ width:110px; }
      .icon-btn{ width:34px; height:30px; }
    }

    button,select,input[type=range],input[type=number]{-webkit-tap-highlight-color:transparent}
    button{background:var(--accent-color);border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:background-color .2s, opacity .2s;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    button.secondary{background:rgba(0,0,0,.2);} button.ghost{background:rgba(0,0,0,.2);}
    label{font-size:12px;color:var(--muted)}

    /* ===== Themed SELECT (ทุกดรอปดาวน์) ===== */
    select, input[type=number]{
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      height:30px; 
      min-width:0;
      padding:0 8px;
      border-radius:8px;
      background:var(--select-bg);
      color:var(--text);
      border:1px solid var(--select-border);
      box-shadow:var(--select-shadow);
      outline:none;
      transition:background .2s,border-color .2s,box-shadow .2s;
    }
    select:hover, input[type=number]:hover{ background:var(--select-bg-hover); }
    select:focus, input[type=number]:focus{ border-color:var(--select-border-focus); box-shadow:var(--select-shadow-focus); }
    select:disabled, input[type=number]:disabled{ opacity:.6; cursor:not-allowed; }

    /* ลูกศรแบบระบบ (คงไว้) + ระยะขอบขวาให้เสมอ */
    select{ padding:0 24px 0 8px; }
    select::-ms-expand{ display:none; }

    /* สีของรายการในดรอปดาวน์ให้ไปตามธีม */
    select option, select optgroup{
      background:var(--card);
      color:var(--text);
    }
     input[type=number] { -moz-appearance:textfield; }
     input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }


    .meters{display:grid;grid-template-columns:1fr;gap:12px}
    canvas{width:100%;height:320px;background:var(--bg1);border-radius:12px;touch-action:none; display:block; transition: background-color .3s;}

    #dbMeterContainer{position:relative;background:rgba(255,255,255,.1);border-radius:999px;overflow:hidden}
    #dbMeterCanvas{height:20px;background:transparent;border-radius:999px}
    .dbLabel{position:absolute;font-size:10px;color:var(--muted);bottom:4px}

    .hint{font-size:12px;color:var(--muted)}
    .badges{display:flex;justify-content:center;gap:6px;flex:1}
    .badge{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.8);border:1px solid rgba(255,255,255,.12);font-size:12px;color:#e5e7eb;white-space:nowrap}
    .tip{position:absolute;padding:4px 6px;font-size:12px;color:#e5e7eb;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.12);border-radius:8px;transform:translate(-50%,-100%);pointer-events:none;white-space:nowrap;z-index:10}
    .plot{position:relative;height:320px;margin-top:8px}

    .values-grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;}
    .kv-item{flex:1;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px;text-align:center}
    .kv-item b{display:block;color:var(--text);font-size:12px;margin-bottom:4px; font-weight:normal; color:var(--muted);}
    .kv-item span{ font-size:18px; font-weight:600; color:var(--text); }
    input[type="range"], input[type="checkbox"]{accent-color:var(--accent-color)}

    /* fullscreen fallback */
    .card.is-fullscreen{position:fixed;inset:0;z-index:9999;margin:0;border-radius:0;width:100vw;height:100vh}
    .card.is-fullscreen .plot{height:calc(100vh - 120px)}
    :fullscreen .plot{height:calc(100vh - 120px)}
    :fullscreen canvas, .card.is-fullscreen canvas{height:100%!important}

    /* Floating command dock */
    .float-dock{
      position:fixed;
      left:calc(8px + env(safe-area-inset-left));
      top:50%;
      transform:translateY(-50%);
      display:flex; flex-direction:column; gap:10px;
      z-index:10000;
    }
    .float-dock .fab{
      width:44px; height:44px;
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px; color:#e5e7eb; font-size:20px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      cursor:pointer;
      transition:transform .08s ease, opacity .2s ease, background .2s ease;
    }
    .float-dock .fab:active{ transform:scale(.96); }
    .float-dock .fab:disabled{ opacity:.55; cursor:not-allowed; }
    .float-dock .fab[aria-pressed="true"]{ background:var(--accent-color); color:#fff; }
    @media (max-width:480px){
      .float-dock .fab{ width:40px; height:40px; font-size:18px; }
    }
  
    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(0,0,0,.85);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font: 14px system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans';
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 9999;
      box-shadow: 0 6px 20px rgba(0,0,0,.35);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* mini step buttons for calibration */
    .btn-step { height:30px; min-width:34px; padding:0 8px; border-radius:8px; font-weight:800; }
  
/* === iPad PWA (Add to Home Screen) fullscreen fix ===
   Target only standalone display-mode so normal browser behavior is unaffected.
   Avoid 100vw/100vh which cause horizontal overflow on iPad PWA.
*/
@media (display-mode: standalone) {
  .card.is-fullscreen{
    position: fixed;
    /* respect safe areas when in standalone */
    top: env(safe-area-inset-top);
    left: env(safe-area-inset-left);
    right: env(safe-area-inset-right);
    bottom: env(safe-area-inset-bottom);
    width: auto;   /* avoid 100vw */
    height: auto;  /* avoid 100vh */
    margin: 0;
    border-radius: 0;
    padding: 12px;
    padding-top: 8px;
    box-sizing: border-box;
    overflow: hidden;
  }
  .card.is-fullscreen .plot{ height: calc(100% - 120px); }
  :fullscreen .plot{ height: calc(100% - 120px); }
}
/* Fallback for older iOS that lacks (display-mode) — use .standalone class set by JS */
html.standalone .card.is-fullscreen{
  position: fixed;
  top: env(safe-area-inset-top);
  left: env(safe-area-inset-left);
  right: env(safe-area-inset-right);
  bottom: env(safe-area-inset-bottom);
  width: auto;
  height: auto;
  margin: 0;
  border-radius: 0;
  padding: 12px 12px 12px 12px;
  padding-top: 8px;
  box-sizing: border-box;
  overflow: hidden;
}
html, body { overflow-x: hidden; } /* prevent accidental horizontal scrollbars in PWA */

</style>
</head>
<body>
  <div class="wrap">
    <!-- Error -->
    <div id="errBox" class="card" style="display:none;border-color:#e53e3e;background:#1c2430">
      <b style="color:#fca5a5">เริ่มวัดไม่ได้</b>
      <div id="errMsg" class="hint" style="color:#fca5a5">—</div>
      <div class="row" style="margin-top:8px">
        <button id="btnStartDemo" class="secondary">🧪 โหมดเดโม่ (ไม่ใช้ไมค์)</button>
        <span class="hint">ถ้าบราวเซอร์บล็อกไมค์ ให้ใช้ HTTPS หรือกดไอคอนรูปกุญแจเพื่ออนุญาต</span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h2 style="margin:0 0 4px 0">my RTAs (v 1.9.3)</h2>
        <div class="row">
          <button id="btnStart">▶️ เริ่มวัด</button>
          <button id="btnStop" class="secondary" disabled>⏸️ หยุด</button>
          <button id="btnHold" class="ghost" aria-pressed="true">📌 Hold Peak: ON</button>
          <button id="btnClear" class="secondary">♻️ Clear Peak & ATH</button>
          <button id="btnAweight" class="ghost" aria-pressed="false" title="สลับ A-weighting">A-weighting: OFF</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <label> Smoothing <input id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.75"></label>
        <label> Averaging <input id="avg" type="checkbox" checked></label>
      </div>

      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <label>พยายามปิด DSP ของระบบ:</label>
          <div class="row">
            <label>echoCancellation <input id="ec" type="checkbox" checked></label>
            <label>noiseSuppression <input id="ns" type="checkbox" checked></label>
            <label>autoGainControl <input id="agc" type="checkbox" checked></label>
          </div>
        </div>
        <label>Theme
          <select id="themeSelector">
            <option value="dark-matter">Dark Matter</option>
            <option value="studio-blue" selected>Studio Blue</option>
            <option value="vintage-amber">Vintage Amber</option>
            <option value="midnight-neon">Midnight Neon</option>
            <option value="emerald-gold">Emerald Gold</option>
          </select>
        </label>
      </div>
    </div>

    <div class="meters">
      <!-- FFT -->
      <div class="card" id="fftCard">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row">
            <b>FFT - </b>
            <select id="fftYScale">
                <option value="log" selected>Log</option>
                <option value="linear">Linear</option>
            </select>
          </div>
          <div class="badges">
            <span class="badge" id="fftPeakText">Peak: —</span>
            <span class="badge" id="fftHoldText" style="display:none;">Hold: —</span>
          </div>
          <div class="toolbar">
            <div class="stack">
              <label>FFT Size
                <input id="fftRangeSlider" type="range" min="0" max="3" step="1" value="1" aria-label="FFT size preset">
                <select id="fftSizePreset">
                  <option value="2048">2048</option>
                  <option value="4096" selected>4096</option>
                  <option value="8192">8192</option>
                  <option value="16384">16384</option>
                </select>
              </label>
            </div>
            <button class="ghost icon-btn" id="fsFFT" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 9V5a2 2 0 0 1 2-2h4"/>
                <path d="M21 9V5a 2 2 0 0 0-2-2h-4"/>
                <path d="M3 15v4a 2 2 0 0 0 2 2h4"/>
                <path d="M21 15v4a 2 2 0 0 1-2 2h-4"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="plot">
          <canvas id="fftCanvas"></canvas>
          <div id="fftTip" class="tip" style="display:none">—</div>
        </div>
      </div>

      <!-- Octave -->
      <div class="card" id="octCard">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row">
            <select id="octRes">
                <option value="3">1/3</option>
                <option value="6">1/6</option>
                <option value="12" selected>1/12</option>
                <option value="24">1/24</option>
            </select>
            <b>Oct</b>
          </div>
          <div class="badges">
            <span class="badge" id="octPeakText">Peak: —</span>
            <span class="badge" id="octHoldText" style="display:none;">Hold: —</span>
          </div>
          <div class="toolbar">
            <div class="stack">
              <label>Range
                <input id="octRangeSlider" type="range" min="64" max="1023" step="1" value="255" aria-label="Octave bar range">
                <select id="octRangePreset">
                  <option value="127">127</option>
                  <option value="255" selected>256</option>
                  <option value="511">512</option>
                </select>
              </label>
              <span class="hint" id="octRangeText">0–255</span>
            </div>
            <button class="ghost icon-btn" id="fsOct" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 9V5a 2 2 0 0 1 2-2h4"/>
                <path d="M21 9V5a 2 2 0 0 0-2-2h-4"/>
                <path d="M3 15v4a 2 2 0 0 0 2 2h4"/>
                <path d="M21 15v4a 2 2 0 0 1-2 2h-4"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="plot">
          <canvas id="octCanvas"></canvas>
          <div id="octTip" class="tip" style="display:none">—</div>
        </div>
      </div>

      <!-- Spectrogram -->
      <div class="card" id="heatmapCard">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row">
            <button id="btnToggleHeatmap" class="ghost" aria-pressed="false">OFF</button>
            <button id="btnHeatmapQuality" class="ghost" aria-pressed="true">HD</button>
          </div>
          <div class="badges">
            <span class="badge" id="heatmapAthText">ATH: —</span>
            <button id="btnClearAth" class="ghost" style="font-size:12px;padding:4px 8px; margin-left:4px;">Clear</button>
          </div>
          <div class="toolbar">
            <div class="stack">
              <label>Range
                <input id="heatmapRangeSlider" type="range" min="5" max="100" step="5" value="50" aria-label="Heatmap range">
                <select id="heatmapRangePreset">
                  <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="40">40</option>
                  <option value="50" selected>50</option><option value="60">60</option><option value="80">80</option><option value="100">100</option>
                </select>
              </label>
              <span class="hint" id="heatmapRangeText">-50 dBFS</span>
            </div>
            <button class="ghost icon-btn" id="fsHeat" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 9V5a 2 2 0 0 1 2-2h4"/>
                <path d="M21 9V5a 2 2 0 0 0-2-2h-4"/>
                <path d="M3 15v4a 2 2 0 0 0 2 2h4"/>
                <path d="M21 15v4a 2 2 0 0 1-2 2h-4"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="plot">
          <canvas id="heatmapCanvas"></canvas>
          <div id="heatmapTip" class="tip" style="display:none">—</div>
        </div>
      </div>

      <!-- dB meter -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:2px">
          <b>ความดังรวม dB</b>
          <button id="btnResetDba" class="secondary" style="font-size:12px;padding:6px 10px;">♻️ Reset AVG/MAX</button>
        </div>
        <div id="dbMeterContainer">
          <canvas id="dbMeterCanvas"></canvas>
          <span class="dbLabel" style="left:0%">0</span>
          <span class="dbLabel" style="left:28.57%">40</span>
          <span class="dbLabel" style="left:57.14%">80</span>
          <span class="dbLabel" style="left:85.71%">120</span>
          <span class="dbLabel" style="right:0">140</span>
        </div>
        <div class="values-grid" style="margin-top:12px;">
          <div class="kv-item"><b>Realtime (dB)</b><span id="dbRealtimeValue">—</span></div>
          <div class="kv-item"><b>AVG (dB)</b><span id="dbAvgValue">—</span></div>
          <div class="kv-item"><b>MAX (dB)</b><span id="dbMaxValue">—</span></div>
        </div>
      </div>

      <!-- RMS / Peak / ATH -->
      <div class="card">
        <div class="values-grid">
          <div class="kv-item">
            <b>ระดับ RMS (ดิบ dBFS)</b>
            <span id="rms">—</span>
          </div>
          <div class="kv-item">
            <b>โน้ตจาก ATH</b>
            <span id="peak">—</span>
          </div>
          <div class="kv-item">
            <b>All-Time High Peak</b>
            <span id="athPeak">—</span>
          </div>
        </div>
      </div>

      <!-- Calibration -->
      <div class="card">
        <div class="row" style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap:8px;">
          <div class="hint" style="flex-basis: 100%; margin-bottom: 4px;">ตั้งค่าออฟเซ็ตเพื่อแปลง dBFS เป็น dB (จากไมค์มือถือ)</div>
          <label for="calibrationSlider" style="flex-shrink: 0;">Offset (dB)</label>
          <button id="btnCalibDec" class="secondary btn-step" aria-label="ลดค่า">−</button>
          <input type="range" id="calibrationSlider" min="50" max="150" step="1" value="85" style="flex:1 1 200px; min-width: 150px;">
          <button id="btnCalibInc" class="secondary btn-step" aria-label="เพิ่มค่า">+</button>
          <input type="number" id="calibrationOffset" value="85" min="50" max="150" step="1" style="width: 70px; text-align: center;">
        </div>
      </div>

      <!-- Disclaimer -->
      <div class="card">
        <p class="hint" style="margin:0; text-align: center;"><b>ข้อจำกัด:</b> ไมค์มือถือมี DSP/AGC และการตอบสนองความถี่ไม่แฟลต ใช้ดูแนว EQ ได้แต่ไม่ใช่วัดระดับ SPL มืออาชีพ</p>
      </div>

    </div>
  </div>

  <!-- Floating command dock (icon-only) -->
  <div class="float-dock" aria-label="Quick controls">
    <button id="fabStart" class="fab" title="เริ่มวัด">▶️</button>
    <button id="fabStop"  class="fab" title="หยุด" disabled>⏸️</button>
    <button id="fabHold"  class="fab" title="Hold Peak" aria-pressed="true">📌</button>
    <button id="fabClear" class="fab" title="Clear Peak & ATH">♻️</button>
    <button id="fabAwt"   class="fab" title="A-weighting" aria-pressed="false">👂</button>
  </div>

  
<script>
// Mark standalone (PWA) mode for older iOS Safari and modern browsers.
(function(){
  try{
    var isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) 
                       || (typeof navigator !== 'undefined' && 'standalone' in navigator && navigator.standalone);
    if(isStandalone){
      document.documentElement.classList.add('standalone');
    }
  }catch(e){/* no-op */}
})();
</script>

<script>
  (() => {
    class RTAnalyzer{
      constructor(){
        this.PAD={L:40,R:10,T:10,B:32};
        this.LABEL_Y=10;
        this.HEATMAP_TIME_SLICES=200;
        this.HEATMAP_BINS_HD=300;
        this.HEATMAP_BINS_SD=60;
        this.FFT_SIZES=[2048,4096,8192,16384];

        this.dom=this.getDOMElements();
        this.colors={};

        this.state={
          audioCtx:null,analyser:null,micSrc:null,stream:null,rafId:null,
          dataArray:null,freqArray:null,
          sampleRate:48000,running:false,
          holdEnabled:true,heatmapEnabled:false,heatmapIsHD:true,
          aWeightEnabled:false,
          fftYScaleIsLog:true,
          peakArray:null,peakOct:null,avgBuffer:null,
          octN:12,bands:[],
          heatmapData:[],heatmapFreqBinMap:null,lastHeatmapUpdate:0,
          athHeatmap:{value:-Infinity,bin:0},
          allTimeHighPeak: { freq: 0, val: -Infinity },
          calibrationOffset:85,
          maxDba:-Infinity,dbaValues:[],
          octRangeMax:255,heatmapRangeMax:50,
          guideFFT:null,guideOCT:null,guideHeatmap:null,
          demo:{enabled:false,oscillators:[],noise:null,gain:null},
          sleepAfterMs:60000, wasRunningBeforeSleep:false, autoDisabledHeatmap:false
        };

        // default theme
        document.documentElement.dataset.theme='studio-blue';
        this.updateColors();
        
        // Sync initial state from DOM
        this.state.calibrationOffset = parseFloat(this.dom.calibrationOffset.value) || 85;
        this.dom.calibrationSlider.value = this.state.calibrationOffset;
        this.state.aWeightEnabled = this.dom.btnAweight.getAttribute('aria-pressed') === 'true';
        this.state.fftYScaleIsLog = this.dom.fftYScale.value === 'log';

        // Floating dock (follow fullscreen)
        this.dock = document.querySelector('.float-dock');
        this.dockHome = this.dock ? this.dock.parentElement : null;

        this.setupEventListeners();
        // --- Sleep Mode timers/flags ---
        this._sleepTimer = null;
        this._hiddenAt = null;
        this._sleeping = false;

        this.setupCanvases();
        this.updateOctaveRangeText();
        this.updateHeatmapRangeText();
        this.drawInitialFrames();
        this.preflight();
      }

      // ====== DOM helpers ======
      getDOMElements(){
        const ids=['btnStart','btnStop','btnHold','btnClear','btnToggleHeatmap','btnHeatmapQuality',
          'btnResetDba','btnClearAth','btnStartDemo','btnAweight','fftSizePreset','smoothing','avg',
          'ec','ns','agc','themeSelector','fftRangeSlider','fftPeakText','fftHoldText','octPeakText',
          'octHoldText','heatmapAthText','fftCanvas','octCanvas','heatmapCanvas','dbMeterCanvas',
          'fftTip','octTip','heatmapTip','dbRealtimeValue','dbAvgValue','dbMaxValue',
          'octRes','octRangePreset','octRangeSlider','octRangeText','heatmapRangeSlider',
          'heatmapRangePreset','heatmapRangeText','rms','peak','athPeak','errBox','errMsg','fsOct','fsFFT','fsHeat',
          'calibrationOffset', 'calibrationSlider', 'fftYScale', 'btnCalibDec','btnCalibInc',
          /* floating buttons */ 'fabStart','fabStop','fabHold','fabClear','fabAwt'
        ];
        const dom={}; ids.forEach(id=>dom[id]=document.getElementById(id));
        dom.fftCard=document.getElementById('fftCard');
        dom.octCard=document.getElementById('octCard');
        dom.heatmapCard=document.getElementById('heatmapCard');
        return dom;
      }

      // ====== Theme / Colors ======
      cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
      updateColors(){
        this.colors={
          gridH:this.cssVar('--gridH'), gridV:this.cssVar('--gridV'), frame:this.cssVar('--frame'), label:this.cssVar('--label'),
          fft:this.cssVar('--fft'), peak:this.cssVar('--peak'), hold:this.cssVar('--hold'),
          heatmap:[this.cssVar('--heatmap-color-1'),this.cssVar('--heatmap-color-2'),this.cssVar('--heatmap-color-3'),this.cssVar('--heatmap-color-4'),this.cssVar('--heatmap-color-5')],
          dba:{g:this.cssVar('--dba-meter-bg-green'), y:this.cssVar('--dba-meter-bg-yellow'), o:this.cssVar('--dba-meter-bg-orange'), r:this.cssVar('--dba-meter-bg-red')}
        };
      }
      applyTheme(theme){
        document.documentElement.dataset.theme = theme;
        this.updateColors();
        this.drawInitialFrames();
      }

      // ====== Sleep / Resume ======
      enterSleep(){ this.showToast('Sleep mode: ปิดไมค์ + Heatmap');
        if(this._sleeping) return; this._sleeping=true;
        this.state.wasRunningBeforeSleep = !!this.state.running;
        if(this.state.heatmapEnabled){ this.state.autoDisabledHeatmap=true; this.state.heatmapEnabled=false; this.dom.btnToggleHeatmap.setAttribute('aria-pressed','false'); this.dom.btnToggleHeatmap.textContent='OFF'; this.drawHeatmapOverlay(); }
        if(this.state.running) this.stop();
      }
      exitSleep(){ this.showToast('กลับมาใช้งาน: เปิดไมค์ต่อ');
        if(!this._sleeping) return; this._sleeping=false;
        if(this.state.wasRunningBeforeSleep && !this.state.running){ this.start().catch?.(()=>{}); }
        if(this.state.autoDisabledHeatmap){ this.state.heatmapEnabled=true; this.state.autoDisabledHeatmap=false; this.dom.btnToggleHeatmap.setAttribute('aria-pressed','true'); this.dom.btnToggleHeatmap.textContent='ON'; }
      }

      preflight(){ if(!navigator.mediaDevices?.getUserMedia){ this.showError('เบราว์เซอร์ไม่รองรับ getUserMedia — ลองใช้ Chrome/Edge/Firefox หรือ Safari รุ่นใหม่'); } }

      // ====== Event Bindings ======
      setupEventListeners(){
        this.dom.btnStart.addEventListener('click',()=>this.start());
        this.dom.btnStartDemo.addEventListener('click',()=>this.startDemo());
        this.dom.btnStop.addEventListener('click',()=>this.stop());
        this.dom.btnClear.addEventListener('click',()=>this.clearPeak());
        this.dom.btnResetDba.addEventListener('click',()=>this.resetDbaValues());

        this.dom.btnHold.addEventListener('click',()=>{
          this.state.holdEnabled=!this.state.holdEnabled;
          this.dom.btnHold.setAttribute('aria-pressed',this.state.holdEnabled);
          this.dom.btnHold.textContent=`📌 Hold Peak: ${this.state.holdEnabled?'ON':'OFF'}`;
          this.syncFloating();
        });
        this.dom.btnAweight.addEventListener('click',()=>{
          this.state.aWeightEnabled=!this.state.aWeightEnabled;
          this.dom.btnAweight.setAttribute('aria-pressed',this.state.aWeightEnabled);
          this.dom.btnAweight.textContent=`A-weighting: ${this.state.aWeightEnabled?'ON':'OFF'}`;
          this.syncFloating();
        });
        this.dom.btnToggleHeatmap.addEventListener('click',()=>{
          this.state.heatmapEnabled=!this.state.heatmapEnabled;
          this.dom.btnToggleHeatmap.setAttribute('aria-pressed',this.state.heatmapEnabled);
          this.dom.btnToggleHeatmap.textContent=this.state.heatmapEnabled?'ON':'OFF';
          if(!this.state.heatmapEnabled) this.drawHeatmapOverlay();
        });
        this.dom.btnHeatmapQuality.addEventListener('click',()=>{
          this.state.heatmapIsHD=!this.state.heatmapIsHD;
          this.dom.btnHeatmapQuality.setAttribute('aria-pressed',this.state.heatmapIsHD);
          this.dom.btnHeatmapQuality.textContent=this.state.heatmapIsHD?'HD':'SD';
          this.state.heatmapFreqBinMap=this.genHeatmapBins();
          this.state.heatmapData=[];
          if(this.state.heatmapEnabled) this.drawHeatmap(true); else this.drawHeatmapOverlay();
        });
        this.dom.btnClearAth.addEventListener('click',()=>{ this.state.athHeatmap={value:-Infinity,bin:0}; this.dom.heatmapAthText.textContent='ATH: —'; });
        this.dom.themeSelector.addEventListener('change',(e)=>this.applyTheme(e.target.value));
        this.dom.fftYScale.addEventListener('change',(e)=>{ this.state.fftYScaleIsLog = e.target.value==='log'; this.drawFFTBackground(); });

        // Calibration bindings
        this.dom.calibrationSlider.addEventListener('input',(e)=>{ const v=parseFloat(e.target.value); if(!isNaN(v)){ this.state.calibrationOffset=v; this.dom.calibrationOffset.value=v; }});
        this.dom.calibrationOffset.addEventListener('input',(e)=>{ const v=parseFloat(e.target.value); if(!isNaN(v)){ this.state.calibrationOffset=v; this.dom.calibrationSlider.value=v; }});
        this.dom.btnCalibDec.addEventListener('click',()=>this.adjustCalibration(-1));
        this.dom.btnCalibInc.addEventListener('click',()=>this.adjustCalibration(+1));

        // FFT size
        this.dom.fftSizePreset.addEventListener('change',(e)=>{ const idx=this.FFT_SIZES.indexOf(parseInt(e.target.value,10)); this.dom.fftRangeSlider.value=idx<0?1:idx; this.onConfigChange(); });
        this.dom.fftRangeSlider.addEventListener('input',(e)=>{ const idx=parseInt(e.target.value,10); const size=this.FFT_SIZES[idx]||4096; this.dom.fftSizePreset.value=size; this.onConfigChange(); });

        this.dom.smoothing.addEventListener('input',()=>{ if(this.state.analyser) this.state.analyser.smoothingTimeConstant=parseFloat(this.dom.smoothing.value); });

        this.dom.octRes.addEventListener('change',()=>{ this.state.octN=parseInt(this.dom.octRes.value,10); this.state.bands=this.genBands(this.state.octN); this.state.peakOct=new Float32Array(this.state.bands.length); });

        ;[this.dom.ec,this.dom.ns,this.dom.agc].forEach(el=>el.addEventListener('change',()=>{ if(this.state.running){ this.stop(); setTimeout(()=>this.start(),50); }}));

        this.dom.octRangePreset.addEventListener('change',(e)=>{ this.state.octRangeMax=parseInt(e.target.value,10); this.dom.octRangeSlider.value=this.state.octRangeMax; this.updateOctaveRangeText(); });
        this.dom.octRangeSlider.addEventListener('input',()=>{ this.state.octRangeMax=parseInt(this.dom.octRangeSlider.value,10); this.updateOctaveRangeText(); });

        this.dom.heatmapRangePreset.addEventListener('change',(e)=>{ this.state.heatmapRangeMax=parseInt(e.target.value,10); this.dom.heatmapRangeSlider.value=this.state.heatmapRangeMax; this.updateHeatmapRangeText(); });
        this.dom.heatmapRangeSlider.addEventListener('input',()=>{ this.state.heatmapRangeMax=parseInt(this.dom.heatmapRangeSlider.value,10); this.updateHeatmapRangeText(); });

        // Sleep-mode based on tab visibility
        const scheduleSleep=()=>{ clearTimeout(this._sleepTimer); this._sleepTimer=setTimeout(()=>this.enterSleep(), this.state.sleepAfterMs); };
        const clearSleep=()=>{ clearTimeout(this._sleepTimer); this._sleepTimer=null; };
        document.addEventListener('visibilitychange',()=>{ if(document.hidden){ this._hiddenAt=Date.now(); scheduleSleep(); } else { const elapsed=this._hiddenAt?(Date.now()-this._hiddenAt):0; clearSleep(); if(this._sleeping||elapsed>=this.state.sleepAfterMs){ this.exitSleep(); } this._hiddenAt=null; }});
        window.addEventListener('blur',()=>{ if(!document.hidden) scheduleSleep(); });
        window.addEventListener('focus',()=>{ clearSleep(); if(this._sleeping) this.exitSleep(); });
        window.addEventListener('pagehide',()=>this.enterSleep());
        window.addEventListener('pageshow',()=>this.exitSleep());

        // Fullscreen
        this.setupFsToggle(this.dom.fsFFT,this.dom.fftCard);
        this.setupFsToggle(this.dom.fsOct,this.dom.octCard);
        this.setupFsToggle(this.dom.fsHeat,this.dom.heatmapCard);

        // Floating buttons
        this.dom.fabStart.addEventListener('click',()=>this.dom.btnStart.click());
        this.dom.fabStop .addEventListener('click',()=>this.dom.btnStop.click());
        this.dom.fabClear.addEventListener('click',()=>this.dom.btnClear.click());
        this.dom.fabHold .addEventListener('click',()=>this.dom.btnHold.click());
        this.dom.fabAwt  .addEventListener('click',()=>this.dom.btnAweight.click());

        window.addEventListener('resize',()=>this.handleResize());
        document.addEventListener('webkitfullscreenchange',()=>this.onFullscreenChange());
        document.addEventListener('fullscreenchange',()=>this.onFullscreenChange());
      }

      // ====== Fullscreen Dock ======
      mountDock(target){ if(!this.dock||!target) return; if(this.dock.parentElement!==target){ target.appendChild(this.dock); } }
      restoreDock(){ if(!this.dock||!this.dockHome) return; if(this.dock.parentElement!==this.dockHome){ this.dockHome.appendChild(this.dock); } }
      onFullscreenChange(){ const fsEl=document.fullscreenElement||document.webkitFullscreenElement||null; if(fsEl&&(fsEl===this.dom.fftCard||fsEl===this.dom.octCard||fsEl===this.dom.heatmapCard)){ this.mountDock(fsEl); } else { this.restoreDock(); } this.handleResize(); }
      setupFsToggle(btn,card){ if(!btn||!card) return; const isActive=()=>document.fullscreenElement===card||document.webkitFullscreenElement===card||card.classList.contains('is-fullscreen'); const showActive=(a)=>btn.setAttribute('data-active',a?'1':'0'); const enter=async()=>{ if(card.requestFullscreen){ try{ await card.requestFullscreen({navigationUI:'hide'});}catch{ card.classList.add('is-fullscreen'); this.mountDock(card);} } else if(card.webkitRequestFullscreen){ try{ card.webkitRequestFullscreen(); }catch{ card.classList.add('is-fullscreen'); this.mountDock(card);} } else { card.classList.add('is-fullscreen'); this.mountDock(card);} this.handleResize(); showActive(true); }; const exit=async()=>{ if((document.fullscreenElement===card||document.webkitFullscreenElement===card) && (document.exitFullscreen||document.webkitExitFullscreen)){ try{ (document.exitFullscreen||document.webkitExitFullscreen).call(document);}catch{ card.classList.remove('is-fullscreen'); this.restoreDock(); } } else { card.classList.remove('is-fullscreen'); this.restoreDock(); } this.handleResize(); showActive(false); }; btn.addEventListener('click',()=>{ isActive()?exit():enter(); }); showActive(isActive()); }

      // ====== Canvas setup ======
      setupCanvases(){
        this.canvases={
          fft:{canvas:this.dom.fftCanvas,ctx:this.dom.fftCanvas.getContext('2d'),tip:this.dom.fftTip},
          oct:{canvas:this.dom.octCanvas,ctx:this.dom.octCanvas.getContext('2d'),tip:this.dom.octTip},
          heatmap:{canvas:this.dom.heatmapCanvas,ctx:this.dom.heatmapCanvas.getContext('2d'),tip:this.dom.heatmapTip},
          dbMeter:{canvas:this.dom.dbMeterCanvas,ctx:this.dom.dbMeterCanvas.getContext('2d')}
        };
        this.handleResize();
        this.attachPressGuide(this.canvases.fft,'fft');
        this.attachPressGuide(this.canvases.oct,'oct');
        this.attachPressGuide(this.canvases.heatmap,'heatmap');
      }
      handleResize(){ const dpr=window.devicePixelRatio||1; for(const k in this.canvases){ const obj=this.canvases[k]; if(!obj||!obj.canvas) continue; const {canvas,ctx}=obj; const rect=canvas.getBoundingClientRect(); canvas.width=rect.width*dpr; canvas.height=rect.height*dpr; if(ctx){ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);} } this.drawInitialFrames(); if(this.state.running){ this.drawFFT(); this.drawOctave(); if(this.state.heatmapEnabled) this.drawHeatmap(true); } }
      drawInitialFrames(){ this.drawFFTBackground(); this.drawLogGrid(this.canvases.oct.ctx); this.drawHeatmapBackground(this.canvases.heatmap.ctx); this.drawHeatmapOverlay(); this.drawDbMeterBackground(); }

      // ====== Audio start/stop ======
      async start(){
        this.dom.btnStart.disabled=true; this.syncFloating();
        try{
          if(!navigator.mediaDevices?.getUserMedia) throw new Error('เบราว์เซอร์ไม่รองรับ getUserMedia API');
          const constraints={audio:{ echoCancellation:{ideal:this.dom.ec.checked}, noiseSuppression:{ideal:this.dom.ns.checked}, autoGainControl:{ideal:this.dom.agc.checked} }};
          let stream; try{ stream=await navigator.mediaDevices.getUserMedia(constraints); }
          catch(e){ if(e && (e.name==='NotAllowedError'||e.name==='SecurityError')){ this.showError('เบราว์เซอร์ไม่อนุญาตใช้ไมโครโฟน (NotAllowed). ใช้ HTTPS และอนุญาตสิทธิ์ หรือใช้โหมดเดโม่'); this.dom.btnStart.disabled=false; this.syncFloating(); return; } if(e && (e.name==='NotFoundError'||e.name==='OverconstrainedError')){ this.showError('ไม่พบอุปกรณ์ไมค์ที่ใช้งานได้'); this.dom.btnStart.disabled=false; this.syncFloating(); return; } try{ stream=await navigator.mediaDevices.getUserMedia({audio:true}); } catch(e2){ this.showError(`เริ่มไมค์ไม่ได้: ${e2.message||e2}`); this.dom.btnStart.disabled=false; this.syncFloating(); return; } }

          const audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'}); if(audioCtx.state==='suspended') await audioCtx.resume();
          const analyser=audioCtx.createAnalyser(); const micSrc=audioCtx.createMediaStreamSource(stream); micSrc.connect(analyser);

          this.state={...this.state,audioCtx,analyser,micSrc,stream,running:true,demo:{...this.state.demo,enabled:false}};
          this.onConfigChange();
          this.resetDbaValues();
          this.dom.errBox.style.display='none';
          this.dom.btnStop.disabled=false;
          this.syncFloating();
          this.loop();
        }catch(err){ console.error(err); this.showError(err.message||String(err)); this.dom.btnStart.disabled=false; this.syncFloating(); }
      }
      async startDemo(){
        try{ const audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'}); if(audioCtx.state==='suspended') await audioCtx.resume(); const analyser=audioCtx.createAnalyser(); const gain=audioCtx.createGain(); gain.gain.value=0.5; const osc1=audioCtx.createOscillator(); osc1.type='sine'; osc1.frequency.value=200; const osc2=audioCtx.createOscillator(); osc2.type='sine'; osc2.frequency.value=1000; const osc3=audioCtx.createOscillator(); osc3.type='sine'; osc3.frequency.value=5000; const nb=audioCtx.createBuffer(1,audioCtx.sampleRate,audioCtx.sampleRate); const data=nb.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.02; const noise=audioCtx.createBufferSource(); noise.buffer=nb; noise.loop=true; osc1.connect(gain); osc2.connect(gain); osc3.connect(gain); noise.connect(gain); gain.connect(analyser); osc1.start(); osc2.start(); osc3.start(); noise.start(); let t=0; const mod=()=>{ t+=0.016; osc1.frequency.value=180+40*Math.sin(t*0.9); osc2.frequency.value=900+150*Math.sin(t*0.7); osc3.frequency.value=4500+600*Math.sin(t*0.5); if(this.state.running && this.state.demo.enabled) requestAnimationFrame(mod); }; this.state={...this.state,audioCtx,analyser,micSrc:null,stream:null,running:true, demo:{enabled:true,oscillators:[osc1,osc2,osc3],noise,gain}}; this.onConfigChange(); this.resetDbaValues(); this.dom.errBox.style.display='none'; this.dom.btnStart.disabled=true; this.dom.btnStop.disabled=false; this.syncFloating(); this.loop(); mod(); }catch(e){ this.showError('เริ่มโหมดเดโม่ไม่ได้: '+(e.message||e)); }
      }
      stop(){ if(!this.state.running) return; this.state.running=false; cancelAnimationFrame(this.state.rafId); this.state.stream?.getTracks().forEach(t=>t.stop()); this.state.micSrc?.disconnect(); if(this.state.demo.enabled){ this.state.demo.oscillators.forEach(o=>{try{o.stop();o.disconnect();}catch{}}); try{this.state.demo.noise.stop(); this.state.demo.noise.disconnect();}catch{} try{this.state.demo.gain.disconnect();}catch{} } this.state.analyser?.disconnect(); try{this.state.audioCtx?.close();}catch{} this.state={...this.state,audioCtx:null,analyser:null,micSrc:null,stream:null,demo:{enabled:false,oscillators:[],noise:null,gain:null}}; this.dom.btnStart.disabled=false; this.dom.btnStop.disabled=true; this.syncFloating(); this.dom.dbRealtimeValue.textContent='—'; this.updateDbMeter(-Infinity); }

      onConfigChange(){ if(!this.state.analyser) return; this.state.analyser.fftSize=parseInt(this.dom.fftSizePreset.value,10); this.state.analyser.smoothingTimeConstant=parseFloat(this.dom.smoothing.value); this.state.dataArray=new Uint8Array(this.state.analyser.fftSize); this.state.freqArray=new Uint8Array(this.state.analyser.frequencyBinCount); this.state.peakArray=new Uint8Array(this.state.analyser.frequencyBinCount); this.state.avgBuffer=new Float32Array(this.state.analyser.frequencyBinCount); this.state.sampleRate=this.state.audioCtx.sampleRate; this.state.bands=this.genBands(this.state.octN); this.state.peakOct=new Float32Array(this.state.bands.length); this.state.heatmapFreqBinMap=this.genHeatmapBins(); this.state.heatmapData=[]; this.state.athHeatmap={value:-Infinity,bin:0}; }

      loop(){ if(!this.state.running) return; this.state.analyser.getByteTimeDomainData(this.state.dataArray); this.state.analyser.getByteFrequencyData(this.state.freqArray); if(this.dom.avg.checked){ const a=0.5; for(let i=0;i<this.state.freqArray.length;i++){ this.state.avgBuffer[i]=a*this.state.avgBuffer[i]+(1-a)*this.state.freqArray[i]; this.state.freqArray[i]=this.state.avgBuffer[i]; } } this.drawFFT(); this.drawOctave(); this.updateRMS(); this.updateDba(); const now=performance.now(); if(this.state.heatmapEnabled && (now-this.state.lastHeatmapUpdate>=33)){ this.drawHeatmap(); this.state.lastHeatmapUpdate=now; } this.state.rafId=requestAnimationFrame(()=>this.loop()); }

      // ====== Math / Helpers ======
      clamp01(v){return Math.min(1,Math.max(0,v));}
      dbfs(v){return 20*Math.log10(v/255+1e-12);}  
      fmtHz(f){return f>=1000?(((f/1000)>=10?(f/1000).toFixed(0):(f/1000).toFixed(1))+' kHz'):(Math.round(f)+' Hz');}
      freqToNote(freq){ if(!(freq>0)||!isFinite(freq)) return '—'; const midi=Math.round(69+12*Math.log2(freq/440)); const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; const name=names[((midi%12)+12)%12]; const octave=Math.floor(midi/12)-1; return `${name}${octave}`; }
      aWeighting(f){const f2=f*f; const ra=(12194**2*f2**2)/((f2+20.6**2)*Math.sqrt((f2+107.7**2)*(f2+737.9**2))*(f2+12194**2)); return 20*Math.log10(ra)+2.00;}
      fmax(){return Math.min(this.state.sampleRate/2,22050);} 
      mapLogX(f,w){const fm=this.fmax(),fmin=20; const t=(Math.log10(Math.max(f,fmin))-Math.log10(fmin))/(Math.log10(fm)-Math.log10(fmin)); return this.PAD.L+t*(w-this.PAD.L-this.PAD.R);} 
      xToFreq(x,w){const fm=this.fmax(),fmin=20; const plotW=w-this.PAD.L-this.PAD.R; const t=this.clamp01((x-this.PAD.L)/plotW); const lf=Math.log10(fmin)+t*(Math.log10(fm)-Math.log10(fmin)); return Math.pow(10,lf);} 
      mapDbToY(db,h){const norm=this.clamp01((db+100)/100); const plotH=h-this.PAD.T-this.PAD.B; return this.PAD.T+(1-norm)*plotH;} 
      mapLinearAmplitudeToY(val,h){ const norm=this.clamp01(val/255); const plotH=h-this.PAD.T-this.PAD.B; return this.PAD.T+(1-norm)*plotH; }
      mapLinearToYOct(v,h){const norm=this.clamp01(v/Math.max(1,this.state.octRangeMax)); const plotH=h-this.PAD.T-this.PAD.B; return this.PAD.T+(1-norm)*plotH;}
      mapDbToColorHeatmap(db){const maxDb=0,minDb=maxDb-this.state.heatmapRangeMax; const t=this.clamp01((db-minDb)/(maxDb-minDb)); if(t<0.25) return this.colors.heatmap[0]; if(t<0.5) return this.colors.heatmap[1]; if(t<0.75) return this.colors.heatmap[2]; if(t<0.9) return this.colors.heatmap[3]; return this.colors.heatmap[4]; }
      freqToBin(f){const N=this.state.freqArray.length; const fpb=this.state.sampleRate/(2*N); return Math.min(N-1,Math.max(0,Math.round(f/fpb))); }

      // ====== Bands & Heatmap bins ======
      genBands(n){
        // fractional-octave bands from ~20 Hz to Nyquist
        const bands=[];
        const r=Math.pow(2,1/n);
        const fmin=20;
        const fmax=this.fmax();
        // start center freq at fmin and step by r
        let fc=fmin;
        const sqrtR=Math.sqrt(r);
        while(fc<=fmax){
          const fl=Math.max(fmin, fc/sqrtR);
          const fh=Math.min(fmax, fc*sqrtR);
          bands.push({fc,fl,fh});
          fc*=r;
        }
        return bands;
      }
      genHeatmapBins(){
        // Map FFT bin -> heatmap row (log scale)
        const N=this.state.analyser ? this.state.analyser.frequencyBinCount : 1024;
        const map=new Uint16Array(N);
        const fmin=20, fmax=this.fmax();
        const fpb=this.state.sampleRate/(2*N);
        const logMin=Math.log10(fmin), logSpan=Math.log10(fmax)-logMin;
        const bins=this.state.heatmapIsHD?this.HEATMAP_BINS_HD:this.HEATMAP_BINS_SD;
        for(let i=0;i<N;i++){
          const f=i*fpb;
          const t=(Math.log10(Math.max(f,fmin))-logMin)/logSpan;
          const idx=Math.max(0, Math.min(bins-1, Math.floor(t*(bins))));
          map[i]=idx;
        }
        return map;
      }

      // ====== Background grids ======
      drawFFTBackground(){ const ctx=this.canvases.fft.ctx; if(!ctx) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=ctx.canvas.height/(devicePixelRatio||1); const plotH=h-this.PAD.T-this.PAD.B; ctx.clearRect(0,0,w,h); ctx.strokeStyle=this.colors.gridH; for(let i=0;i<6;i++){ const y=this.PAD.T+(i/5)*plotH; ctx.beginPath(); ctx.moveTo(this.PAD.L,y); ctx.lineTo(w-this.PAD.R,y); ctx.stroke(); } ctx.strokeStyle=this.colors.gridV; const ticks=[20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000]; ticks.forEach(t=>{ const x=this.mapLogX(t,w); ctx.beginPath(); ctx.moveTo(x,this.PAD.T); ctx.lineTo(x,this.PAD.T+plotH); ctx.stroke(); }); ctx.strokeStyle=this.colors.frame; ctx.strokeRect(this.PAD.L,this.PAD.T,w-this.PAD.L-this.PAD.R,plotH); ctx.fillStyle=this.colors.label; ctx.font='12px system-ui'; ctx.textBaseline='alphabetic'; [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{ const x=this.mapLogX(t,w); ctx.fillText(t>=1000?(t/1000)+'k':t,x-8,h-this.LABEL_Y); }); ctx.textAlign='right'; ctx.textBaseline='middle'; for(let i=0;i<=5;i++){ const y=this.PAD.T+(i/5)*plotH; const label=this.state.fftYScaleIsLog?`${-i*20}`:(1-i/5).toFixed(1); ctx.fillText(label,this.PAD.L-8,y); } }
      drawLogGrid(ctx){ if(!ctx) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=ctx.canvas.height/(devicePixelRatio||1); const plotH=h-this.PAD.T-this.PAD.B; ctx.clearRect(0,0,w,h); ctx.strokeStyle=this.colors.gridH; for(let i=0;i<6;i++){ const y=this.PAD.T+(i/5)*plotH; ctx.beginPath(); ctx.moveTo(this.PAD.L,y); ctx.lineTo(w-this.PAD.R,y); ctx.stroke(); } ctx.strokeStyle=this.colors.gridV; const ticks=[20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000]; ticks.forEach(t=>{ const x=this.mapLogX(t,w); ctx.beginPath(); ctx.moveTo(x,this.PAD.T); ctx.lineTo(x,this.PAD.T+plotH); ctx.stroke(); }); ctx.strokeStyle=this.colors.frame; ctx.strokeRect(this.PAD.L,this.PAD.T,w-this.PAD.L-this.PAD.R,plotH); ctx.fillStyle=this.colors.label; ctx.font='12px system-ui'; ctx.textBaseline='alphabetic'; [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{ const x=this.mapLogX(t,w); ctx.fillText(t>=1000?(t/1000)+'k':t,x-8,h-this.LABEL_Y); }); }
      drawHeatmapBackground(ctx){ if(!ctx) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=ctx.canvas.height/(devicePixelRatio||1); ctx.clearRect(0,0,w,h); ctx.fillStyle='transparent'; ctx.fillRect(0,0,w,h); ctx.strokeStyle=this.colors.frame; ctx.strokeRect(this.PAD.L,this.PAD.T,w-this.PAD.L-this.PAD.R,h-this.PAD.T-this.PAD.B); }
      drawHeatmapOverlay(){ const {ctx}=this.canvases.heatmap; if(!ctx) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=ctx.canvas.height/(devicePixelRatio||1); ctx.save(); ctx.fillStyle='rgba(0,0,0,.4)'; ctx.fillRect(this.PAD.L,this.PAD.T,w-this.PAD.L-this.PAD.R,h-this.PAD.T-this.PAD.B); ctx.fillStyle=this.colors.label; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.fillText('Heatmap OFF', (w)/2, this.PAD.T+20); ctx.restore(); }

      // ====== Drawing helpers ======
      drawPeakLine(ctx,x,wCss,hCss,color,dashed=false,labelText=null){ const y0=this.PAD.T, y1=hCss-this.PAD.B; ctx.save(); ctx.strokeStyle=color; ctx.lineWidth=1; if(dashed) ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke(); ctx.restore(); if(!labelText) return; ctx.save(); ctx.font='12px system-ui'; const padX=6, textW=ctx.measureText(labelText).width; const boxW=textW+padX*2, boxH=18; let bx=Math.round(x-boxW/2); const minX=this.PAD.L+2, maxX=(wCss-this.PAD.R)-boxW-2; if(bx<minX) bx=minX; if(bx>maxX) bx=maxX; const by=y0+2; ctx.fillStyle='rgba(0,0,0,.85)'; ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.lineWidth=1; const r=8; ctx.beginPath(); ctx.moveTo(bx+r,by); ctx.lineTo(bx+boxW-r,by); ctx.quadraticCurveTo(bx+boxW,by,bx+boxW,by+r); ctx.lineTo(bx+boxW,by+boxH-r); ctx.quadraticCurveTo(bx+boxW,by+boxH,bx+boxW-r,by+boxH); ctx.lineTo(bx+r,by+boxH); ctx.quadraticCurveTo(bx,by+boxH,bx,by+boxH-r); ctx.lineTo(bx,by+r); ctx.quadraticCurveTo(bx,by,bx+r,by); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.fillStyle=this.colors.label||'#e5e7eb'; ctx.textBaseline='middle'; ctx.textAlign='center'; ctx.fillText(labelText,bx+boxW/2,by+boxH/2+0.5); ctx.restore(); }
      attachPressGuide(obj,type){ const {canvas,tip}=obj; if(!canvas||!tip) return; const show=(x,y,text)=>{ tip.style.display='block'; tip.style.left=x+'px'; tip.style.top=y+'px'; tip.textContent=text; }; const hide=()=>{ tip.style.display='none'; }; canvas.addEventListener('pointerleave',hide); canvas.addEventListener('pointermove',(ev)=>{ const rect=canvas.getBoundingClientRect(); const x=ev.clientX-rect.left, y=ev.clientY-rect.top; const w=rect.width, h=rect.height; if(type==='fft'){ const f=this.xToFreq(x,w); show(x, y, this.fmtHz(f)); } else if(type==='oct'){ const f=this.xToFreq(x,w); show(x,y, this.fmtHz(f)); } else { show(x,y, ''); } }); }

      // ====== Calibration helpers ======
      adjustCalibration(delta){
        const slider=this.dom.calibrationSlider;
        const input=this.dom.calibrationOffset;
        const min=parseFloat(slider.min)||0;
        const max=parseFloat(slider.max)||100;
        const step=parseFloat(slider.step)||1;
        let v=parseFloat(slider.value)||0;
        v += delta*step;
        v = Math.min(max, Math.max(min, v));
        slider.value=v; input.value=v; this.state.calibrationOffset=v;
      }

      // ====== FFT / Octave / Heatmap ======
      drawFFT(){ const {ctx}=this.canvases.fft; if(!ctx) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=ctx.canvas.height/(devicePixelRatio||1); this.drawFFTBackground(); if(!this.state.freqArray) return; const N=this.state.freqArray.length, fpb=this.state.sampleRate/(2*N);
        if(this.state.holdEnabled){ for(let i=0;i<N;i++) this.state.peakArray[i]=Math.max(this.state.peakArray[i],this.state.freqArray[i]); }
        ctx.beginPath(); let started=false; for(let i=1;i<N;i++){ const f=i*fpb; if(f>this.fmax()||f<20) continue; const x=this.mapLogX(f,w); const y=this.state.fftYScaleIsLog?this.mapDbToY(this.dbfs(this.state.freqArray[i]),h):this.mapLinearAmplitudeToY(this.state.freqArray[i],h); if(!started){ctx.moveTo(x,y); started=true;} else ctx.lineTo(x,y);} ctx.strokeStyle=this.colors.fft; ctx.lineWidth=2; ctx.stroke();
        ctx.beginPath(); started=false; for(let i=1;i<N;i++){ const f=i*fpb; if(f>this.fmax()||f<20) continue; const x=this.mapLogX(f,w); const y=this.state.fftYScaleIsLog?this.mapDbToY(this.dbfs(this.state.peakArray[i]||0),h):this.mapLinearAmplitudeToY(this.state.peakArray[i]||0,h); if(!started){ctx.moveTo(x,y); started=true;} else ctx.lineTo(x,y);} ctx.save(); ctx.globalAlpha=.35; ctx.strokeStyle=this.colors.peak; ctx.lineWidth=1.25; ctx.stroke(); ctx.restore();
        let peakBin=0,peakVal=-Infinity; for(let i=0;i<N;i++){ if(this.state.freqArray[i]>peakVal){ peakVal=this.state.freqArray[i]; peakBin=i; }} const peakHz=peakBin*fpb; this.dom.fftPeakText.textContent=`Peak: ${this.fmtHz(peakHz)}`; if(peakVal>this.state.allTimeHighPeak.val){ this.state.allTimeHighPeak={freq:peakHz,val:peakVal}; this.dom.athPeak.textContent=this.fmtHz(this.state.allTimeHighPeak.freq); this.dom.heatmapAthText.textContent=`ATH: ${this.fmtHz(this.state.allTimeHighPeak.freq)}`; } this.dom.peak.textContent=this.freqToNote(this.state.allTimeHighPeak.freq||0);
        const holdHz=peakHz; this.dom.fftHoldText.textContent=`Hold: ${this.fmtHz(holdHz)}`; this.drawPeakLine(ctx,this.mapLogX(holdHz,w),w,h,this.colors.hold,true,`${Math.round(holdHz)} Hz`);
      }
      drawOctave(){ const {ctx}=this.canvases.oct; if(!ctx||!this.state.freqArray) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=ctx.canvas.height/(devicePixelRatio||1); this.drawLogGrid(ctx); const bands=this.genBands(this.state.octN); const mags=new Float32Array(bands.length).fill(0); for(let i=0;i<bands.length;i++){ const b=bands[i]; const b1=this.freqToBin(b.fl), b2=this.freqToBin(b.fh); let sum=0,cnt=0; for(let k=b1;k<=b2;k++){ sum+=this.dbfs(this.state.freqArray[k]); cnt++; } mags[i]=sum/Math.max(1,cnt); }
        ctx.beginPath(); let started=false; for(let i=0;i<bands.length;i++){ const f=bands[i].fc; const x=this.mapLogX(f,w); const y=Math.min(h-this.PAD.B,Math.max(this.PAD.T,this.mapDbToY(mags[i],h))); if(!started){ctx.moveTo(x,y); started=true;} else ctx.lineTo(x,y);} ctx.save(); ctx.strokeStyle=this.colors.peak; ctx.lineWidth=1.25; ctx.globalAlpha=.9; ctx.stroke(); ctx.restore();
        let maxI=0,maxV=-Infinity; for(let i=0;i<mags.length;i++){ if(mags[i]>maxV){maxV=mags[i]; maxI=i;} } const center=bands[maxI].fc; this.dom.octPeakText.textContent=`Peak: ${this.fmtHz(center)}`; this.dom.octHoldText.textContent=`Hold: ${this.fmtHz(center)}`; this.drawPeakLine(ctx,this.mapLogX(center,w),w,h,this.colors.hold,true,`${Math.round(center)} Hz`);
      }
      drawHeatmap(force=false){ const {ctx}=this.canvases.heatmap; if(!ctx) return; const w=ctx.canvas.clientWidth, h=ctx.canvas.clientHeight; if(force){ ctx.clearRect(0,0,w,h);} ctx.save(); const bins=this.state.heatmapIsHD?this.HEATMAP_BINS_HD:this.HEATMAP_BINS_SD; const xFromRight=2; const colH=(h-this.PAD.T-this.PAD.B)/bins; for(let i=0;i<bins;i++){ const y=h-this.PAD.B-colH*(i+1); const v=Math.random(); const hue=240 - v*240; ctx.fillStyle=`hsl(${hue} 90% 50% / .85)`; ctx.fillRect(w-this.PAD.R-xFromRight, y, 2, colH); } ctx.restore(); }

      // ====== dB & RMS ======
      updateRMS(){ if(!this.state.dataArray) return; // byte 0..255
        let sum=0; for(let i=0;i<this.state.dataArray.length;i++){ const x=(this.state.dataArray[i]-128)/128; sum+=x*x; } const rms=Math.sqrt(sum/this.state.dataArray.length); const dbfs=20*Math.log10(rms+1e-12); this.dom.rms.textContent=isFinite(dbfs)?dbfs.toFixed(1)+' dBFS':'—'; }
      updateDbaFromDbfs(dbfs){ const dba = dbfs + this.state.calibrationOffset; return dba; }
      updateDba(){ if(!this.state.dataArray) return; let sum=0; for(let i=0;i<this.state.dataArray.length;i++){ const x=(this.state.dataArray[i]-128)/128; sum+=x*x; } const rms=Math.sqrt(sum/this.state.dataArray.length); const dbfs=20*Math.log10(rms+1e-12); const dba=this.updateDbaFromDbfs(dbfs); if(isFinite(dba)){ this.state.dbaValues.push(dba); if(this.state.dbaValues.length>120) this.state.dbaValues.shift(); const avg=this.state.dbaValues.reduce((a,b)=>a+b,0)/this.state.dbaValues.length; this.state.maxDba=Math.max(this.state.maxDba,dba); this.dom.dbRealtimeValue.textContent=Math.round(dba); this.dom.dbAvgValue.textContent=Math.round(avg); this.dom.dbMaxValue.textContent=Math.round(this.state.maxDba); this.updateDbMeter(dba); } }
      resetDbaValues(){ this.state.dbaValues=[]; this.state.maxDba=-Infinity; this.dom.dbAvgValue.textContent='—'; this.dom.dbMaxValue.textContent='—'; }

      drawDbMeterBackground(){ const {ctx}=this.canvases.dbMeter; if(!ctx) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=20; ctx.canvas.height=h*(devicePixelRatio||1); ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(0,0,w,h); }
      updateDbMeter(val){ const {ctx}=this.canvases.dbMeter; if(!ctx) return; const w=ctx.canvas.width/(devicePixelRatio||1), h=ctx.canvas.height/(devicePixelRatio||1); ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(0,0,w,h); const pct=this.clamp01((val)/140); let color=this.colors.dba.g; if(val>=85) color=this.colors.dba.y; if(val>=100) color=this.colors.dba.o; if(val>=120) color=this.colors.dba.r; ctx.fillStyle=color||'#22D3EE'; ctx.fillRect(0,0,Math.round(w*pct),h); }

      // ====== UI text ======
      updateOctaveRangeText(){ this.dom.octRangeText.textContent=`0–${this.state.octRangeMax}`; }
      updateHeatmapRangeText(){ this.dom.heatmapRangeText.textContent=`-${this.state.heatmapRangeMax} dBFS`; }

      // ====== Errors / Toasts ======
      showError(msg){ this.dom.errMsg.textContent=msg||'Unknown error'; this.dom.errBox.style.display='block'; }
      showToast(message){ let t=document.querySelector('.toast'); if(!t){ t=document.createElement('div'); t.className='toast'; document.body.appendChild(t); } t.textContent=message; t.classList.add('show'); clearTimeout(this._toastTimer); this._toastTimer=setTimeout(()=>t.classList.remove('show'), 2000); }

      // ====== Floating dock sync ======
      syncFloating(){ this.dom.fabStart.disabled=this.dom.btnStart.disabled; this.dom.fabStop.disabled=this.dom.btnStop.disabled; this.dom.fabHold.setAttribute('aria-pressed',this.state.holdEnabled); this.dom.fabAwt.setAttribute('aria-pressed',this.state.aWeightEnabled); }

      // ====== Clear peaks / ATH ======
      clearPeak(){
        if(this.state.peakArray) this.state.peakArray.fill(0);
        if(this.state.peakOct) this.state.peakOct.fill(-Infinity);
        this.state.allTimeHighPeak={freq:0,val:-Infinity};
        this.dom.athPeak.textContent='—';
        this.dom.heatmapAthText.textContent='ATH: —';
        this.dom.fftPeakText.textContent='Peak: —';
        this.dom.fftHoldText.textContent='Hold: —';
        this.dom.octPeakText.textContent='Peak: —';
        this.dom.octHoldText.textContent='Hold: —';
      }
    }

    // ====== Boot ======
    const app=new RTAnalyzer();

    // ====== Tiny tests (console) ======
    (function runTests(){
      const t = (name,fn)=>{ try{ fn(); console.log('%cPASS','color:#10B981;font-weight:bold', name); } catch(e){ console.error('FAIL', name, e); }};
      // freqToNote
      t('A4 @ 440 Hz => A4', ()=>{ if(app.freqToNote(440)!=='A4') throw new Error(app.freqToNote(440)); });
      t('C4 ~ 261.63 Hz => C4', ()=>{ const n=app.freqToNote(261.63); if(n!=='C4') throw new Error(n); });
      t('freqToNote invalid => —', ()=>{ if(app.freqToNote(0)!=='—') throw new Error('expected —'); });
      // mapLogX monotonic
      t('mapLogX monotonic', ()=>{ const x1=app.mapLogX(100,300), x2=app.mapLogX(1000,300); if(!(x2>x1)) throw new Error('not monotonic'); });
      // dB meter calc should not NaN
      t('updateDbaFromDbfs finite', ()=>{ const v=app.updateDbaFromDbfs(-20); if(!isFinite(v)) throw new Error('NaN'); });
      // calibration adjust stepper
      t('calibration +1 within bounds', ()=>{ const s=app.dom.calibrationSlider; const prev=parseFloat(s.value); app.adjustCalibration(+1); const now=parseFloat(s.value); const max=parseFloat(s.max); if(now!==Math.min(prev+1,max)) throw new Error(`${prev} -> ${now}`); });
      t('calibration sync number', ()=>{ const s=app.dom.calibrationSlider; const n=app.dom.calibrationOffset; if(parseFloat(s.value)!==parseFloat(n.value)) throw new Error('desync'); });
      t('calibration not below min', ()=>{ const s=app.dom.calibrationSlider; s.value=s.min; app.adjustCalibration(-5); if(parseFloat(s.value)!==parseFloat(s.min)) throw new Error('below min'); });
      // genBands shape
      t('genBands returns bands', ()=>{ const b=app.genBands(12); if(!Array.isArray(b)||b.length===0||!('fc' in b[0])) throw new Error('bad bands'); });
      t('genHeatmapBins length', ()=>{ const m=app.genHeatmapBins(); if(!m || m.length===0) throw new Error('bad map'); });
    })();
  })();
  </script>
</body>
</html>
